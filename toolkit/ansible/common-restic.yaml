- name: Check if export file exists
  stat:
    path: "{{ export_json }}"
  register: file_check

- name: Fail if export file does not exist
  fail:
    msg: "The required file {{ export_json }} does not exist!"
  when: not file_check.stat.exists

- name: Run Restic backup
  shell: |
    restic backup --host {{ lookup('ansible.builtin.env', 'HOST') | default(ansible_hostname, true) }} \
      --tag backup_type:{{ backup_type }} \
      --tag environment:{{ backup_environment | default('production') }} \
      {% if version_tag is defined %}--tag version:{{ version_tag }} {% endif %}\
      "{{ export_json }}"
  environment: "{{ restic_env }}"
  register: restic_backup_result

- name: Run Restic check
  shell: restic check --read-data-subset 1/10
  environment: "{{ restic_env }}"
  register: restic_check_result

- name: Run Restic forget and prune snapshots
  shell: restic forget --keep-daily 30 --keep-monthly 3 --keep-yearly 1 --prune
  environment: "{{ restic_env }}"
  register: restic_forget_result

- name: Signal success to healthchecks.io
  community.healthchecksio.ping:
    state: present
    uuid: "{{ healthchecks_uuid }}"
    api_key: "{{ healthchecks_api_key }}"
    signal: "success"