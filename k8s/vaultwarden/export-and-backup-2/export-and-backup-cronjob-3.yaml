apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup-vaultwarden-debian
spec:
  schedule: "0 22 * * *"
  concurrencyPolicy: Forbid
  startingDeadlineSeconds: 600
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  suspend: false
  jobTemplate:
    spec:
      backoffLimit: 0
      template:
        spec:
          restartPolicy: Never

          volumes:
            - name: export
              emptyDir: {}
            - name: cache
              persistentVolumeClaim:
                claimName: vaultwarden-support-pvc
            - name: restic-backup-script
              configMap:
                name: restic-backup-script
            - name: policies
              secret:
                secretName: all-in-one
                items:
                  - key: restic-policy.json
                    path: restic-policy.json
                  - key: deny-all-policy.json
                    path: deny-all-policy.json
                  - key: public-access-block-restic.json
                    path: public-access-block-restic.json
                  - key: public-access-block-deny-all.json
                    path: public-access-block-deny-all.json

          initContainers:
            - name: vaultwarden-export
              image: ghcr.io/tryrocket-cloud/home-ops:toolkit-dac626759170cfa9660ede089433470c89ca40a2
              imagePullPolicy: IfNotPresent
              env:
                - name: TZ
                  value: Europe/Berlin
                - name: VAULTWARDEN_HOST
                  value: vaultwarden.tryrocket.cloud
                - name: VAULTWARDEN_USER_ID
                  value: 2967ac9f-f0e5-4881-8be5-9d08371a167a
              envFrom:
                - secretRef:
                    name: all-in-one
              volumeMounts:
                - name: export
                  mountPath: /export
                - name: restic-backup-script
                  mountPath: /scripts
                - name: policies
                  mountPath: /policies
              command:
                - /bin/bash
                - -c
              args:
                - |
                  set -exuo pipefail

                  log()   { echo "[INFO]  $(date -Iseconds) $*"; }
                  warn()  { echo "[WARN]  $(date -Iseconds) $*" >&2; }
                  error() { echo "[ERROR] $(date -Iseconds) $*" >&2; exit 1; }
                  check_file() { [[ -s "$1" ]] || error "File missing or empty: $1"; }

                  VW_VERSION=$(curl -fsS -m 10 "https://${VAULTWARDEN_HOST}/api/config" | jq -r '.version // empty')
                  [[ -n "$VW_VERSION" ]] || error "Unable to retrieve Vaultwarden version"

                  log "Logging into Bitwarden and exporting data…"
                  bw config server "https://${VAULTWARDEN_HOST}"
                  export BW_SESSION
                  BW_SESSION=$(bw login --raw --cleanexit "${VAULTWARDEN_USERNAME}" "${VAULTWARDEN_PASSWORD}")
                  bw sync --cleanexit --quiet

                  enc_json="/export/vaultwarden-${VAULTWARDEN_USER_ID}.encrypted.json"
                  plain_json="/export/vaultwarden-${VAULTWARDEN_USER_ID}.plain.json"

                  bw export --format encrypted_json --password "${VAULTWARDEN_PASSWORD}" --output "${enc_json}" --cleanexit --quiet
                  bw export --format json --output "${plain_json}" --cleanexit --quiet
                  bw logout --cleanexit --quiet

                  check_file "${enc_json}"
                  check_file "${plain_json}"

                  log "Encrypting export with age…"
                  cipher_file="/export/vaultwarden-${VAULTWARDEN_USER_ID}.age"
                  age --recipient "${AGE_RECIPIENT}" --output "${cipher_file}" "${plain_json}"
                  check_file "${cipher_file}"
                  head -c21 "${cipher_file}" | grep -q '^age-encryption\.org/v1' || error "Invalid age header"
                  rm -f "${plain_json}"

          containers:
            - name: backup
              image: ghcr.io/tryrocket-cloud/home-ops:toolkit-dac626759170cfa9660ede089433470c89ca40a2
              imagePullPolicy: IfNotPresent
              env:
                - name: TZ
                  value: Europe/Berlin
                - name: VAULTWARDEN_HOST
                  value: vaultwarden.tryrocket.cloud
                - name: VAULTWARDEN_USER_ID
                  value: 2967ac9f-f0e5-4881-8be5-9d08371a167a
                - name: BW_CLI_VERSION
                  value: "2025.4.0"
                - name: HOSTNAME
                  value: tryrocket.cloud
                - name: RESTIC_CACHE_DIR
                  value: /cache/ionos.com/vaultwarden/restic
              envFrom:
                - secretRef:
                    name: all-in-one
                - secretRef:
                    name: healthchecksio
              volumeMounts:
                - name: export
                  mountPath: /export
                - name: cache
                  mountPath: /cache
                - name: restic-backup-script
                  mountPath: /scripts
                - name: policies
                  mountPath: /policies
              command:
                - /bin/bash
                - -eo
                - pipefail
                - -c
              args:
                - |
                  curl -fsS -m 10 "${HC_URL}/start" > /dev/null 2>&1
                  # bash /scripts/restic-backup.sh