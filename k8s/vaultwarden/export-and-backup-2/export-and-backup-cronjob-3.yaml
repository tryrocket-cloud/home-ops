apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup-vaultwarden-debian
spec:
  schedule: "0 22 * * *"
  concurrencyPolicy: Forbid
  startingDeadlineSeconds: 600
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  suspend: false
  jobTemplate:
    spec:
      backoffLimit: 0
      template:
        spec:
          restartPolicy: Never

          volumes:
            - name: export
              emptyDir: {}
            - name: cache
              persistentVolumeClaim:
                claimName: vaultwarden-support-pvc
            - name: backup-script
              configMap:
                name: vaultwarden-backup-script
            - name: policies
              secret:
                secretName: all-in-one
                items:
                  - key: restic-policy.json
                    path: restic-policy.json
                  - key: deny-all-policy.json
                    path: deny-all-policy.json
                  - key: public-access-block-restic.json
                    path: public-access-block-restic.json
                  - key: public-access-block-deny-all.json
                    path: public-access-block-deny-all.json
          containers:
            - name: backup
              image: ghcr.io/tryrocket-cloud/home-ops:toolkit
              imagePullPolicy: Always # TOOD: Change to IfNotPresent
              env:
                - name: VAULTWARDEN_HOST
                  value: vaultwarden.tryrocket.cloud
                - name: VAULTWARDEN_USER_ID
                  value: 2967ac9f-f0e5-4881-8be5-9d08371a167a
                - name: BW_CLI_VERSION
                  value: "2025.4.0"
                - name: HOSTNAME
                  value: tryrocket.cloud
                - name: RESTIC_CACHE_DIR
                  value: /cache/ionos.com/vaultwarden/restic
              envFrom:
                - secretRef:
                    name: all-in-one
                - secretRef:
                    name: healthchecksio
              volumeMounts:
                - name: export
                  mountPath: /export
                - name: cache
                  mountPath: /cache
                - name: backup-script
                  mountPath: /scripts
                - name: policies
                  mountPath: /policies
              command:
                - /bin/bash
                - -exo
                - pipefail
                - -c
              args:
                - |
                  bash /scripts/backup.sh