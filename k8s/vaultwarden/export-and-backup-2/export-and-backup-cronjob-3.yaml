apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup-vaultwarden-debian
spec:
  schedule: "0 22 * * *"
  concurrencyPolicy: Forbid
  startingDeadlineSeconds: 600
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  suspend: false
  jobTemplate:
    spec:
      backoffLimit: 0
      template:
        spec:
          restartPolicy: Never

          volumes:
            - name: export
              emptyDir: {}
            - name: signals
              emptyDir: {}
            - name: cache
              persistentVolumeClaim:
                claimName: vaultwarden-support-pvc
            - name: restic-backup-script
              configMap:
                name: restic-backup-script
            - name: policies
              secret:
                secretName: all-in-one
                items:
                  - key: restic-policy.json
                    path: restic-policy.json
                  - key: deny-all-policy.json
                    path: deny-all-policy.json
                  - key: public-access-block-restic.json
                    path: public-access-block-restic.json
                  - key: public-access-block-deny-all.json
                    path: public-access-block-deny-all.json

          initContainers:
            - name: vaultwarden-export
              image: ghcr.io/tryrocket-cloud/home-ops:toolkit-ac3e21cade59942ed7c1ef4a8dc595b3a71d815a
              imagePullPolicy: IfNotPresent
              env:
                - name: TZ
                  value: Europe/Berlin
                - name: VAULTWARDEN_HOST
                  value: vaultwarden.tryrocket.cloud
                - name: VAULTWARDEN_USER_ID
                  value: 2967ac9f-f0e5-4881-8be5-9d08371a167a
              envFrom:
                - secretRef:
                    name: all-in-one
              volumeMounts:
                - name: export
                  mountPath: /export
                - name: restic-backup-script
                  mountPath: /scripts
                - name: policies
                  mountPath: /policies
              command:
                - /bin/bash
                - -c
              args:
                - |
                  set -euo pipefail

                  log()   { echo "[INFO]  $(date -Iseconds) $*"; }
                  warn()  { echo "[WARN]  $(date -Iseconds) $*" >&2; }
                  error() { echo "[ERROR] $(date -Iseconds) $*" >&2; exit 1; }
                  check_file() { [[ -s "$1" ]] || error "File missing or empty: $1"; }

                  get_vaultwarden_version() {
                    VW_VERSION=$(curl -fsS -m 10 "https://${VAULTWARDEN_HOST}/api/config" \
                      | jq -r '.version // empty')
                    [[ -n "$VW_VERSION" ]] || error "Unable to retrieve Vaultwarden version"
                    echo "export VW_VERSION=${VW_VERSION}" > /export/.env
                    check_file "/export/.env"
                  }

                  export_vaultwarden_vault() {
                    log "Logging into Bitwarden and exporting data…"
                    bw config server "https://${VAULTWARDEN_HOST}"
                    export BW_SESSION
                    BW_SESSION=$(bw login --raw --cleanexit "${VAULTWARDEN_USERNAME}" "${VAULTWARDEN_PASSWORD}")
                    bw sync --cleanexit --quiet

                    local enc_json="/export/vaultwarden-${VAULTWARDEN_USER_ID}.encrypted.json"
                    local plain_json="/export/vaultwarden-${VAULTWARDEN_USER_ID}.plain.json"

                    bw export --format encrypted_json \
                      --password "${VAULTWARDEN_PASSWORD}" \
                      --output "${enc_json}" --cleanexit --quiet

                    bw export --format json \
                      --output "${plain_json}" --cleanexit --quiet

                    bw logout --cleanexit --quiet

                    check_file "${enc_json}"
                    check_file "${plain_json}"

                    log "Encrypting export with age…"
                    local cipher_file="/export/vaultwarden-${VAULTWARDEN_USER_ID}.age"
                    age --recipient "${AGE_RECIPIENT}" --output "${cipher_file}" "${plain_json}"
                    check_file "${cipher_file}"
                    head -c21 "${cipher_file}" \
                      | grep -q '^age-encryption\.org/v1' \
                      || error "Invalid age header"
                    rm -f "${plain_json}"
                  }

                  run_job_buffered() {
                    local name="$1"; shift
                    local tmp; tmp=$(mktemp)
                    (
                      { "$@"; } >"$tmp" 2>&1
                      echo "─── [${name}] done ───"
                      sed "s/^/[${name}] /" "$tmp"
                      rm -f "$tmp"
                    ) &
                  }

                  run_job_buffered 'get vaultwarden version' get_vaultwarden_version
                  run_job_buffered 'export vaultwarden vault' export_vaultwarden_vault

                  wait
                  echo "All jobs finished!"

                  #export -f get_vaultwarden_version export_vaultwarden_vault log warn error check_file

                  #log "Starting Vaultwarden export…"
                  #parallel ::: get_vaultwarden_version export_vaultwarden_vault
                  #log "Vaultwarden export completed."

          containers:
            - name: backup
              image: ghcr.io/tryrocket-cloud/home-ops:toolkit-ac3e21cade59942ed7c1ef4a8dc595b3a71d815a
              imagePullPolicy: IfNotPresent
              env:
                - name: TZ
                  value: Europe/Berlin
                - name: VAULTWARDEN_HOST
                  value: vaultwarden.tryrocket.cloud
                - name: VAULTWARDEN_USER_ID
                  value: 2967ac9f-f0e5-4881-8be5-9d08371a167a
                - name: BW_CLI_VERSION
                  value: "2025.4.0"
                - name: HOSTNAME
                  value: tryrocket.cloud
                - name: RESTIC_CACHE_DIR
                  value: /cache/ionos.com/vaultwarden/restic
                - name: HC_URL
                  value: https://hc-ping.com
                - name: BACKUP_DATA_PATH
                  value: /export
              envFrom:
                - secretRef:
                    name: all-in-one
                - secretRef:
                    name: healthchecksio
              volumeMounts:
                - name: export
                  mountPath: /export
                - name: signals
                  mountPath: /signals
                - name: cache
                  mountPath: /cache
                - name: restic-backup-script
                  mountPath: /scripts
                - name: policies
                  mountPath: /policies
              command:
                - /bin/bash
                - -eo
                - pipefail
                - -c
              args:
                - |
                  hc_ping() { curl -fsS -m 10 "${HC_URL}/${HC_UUID}" > /dev/null 2>&1; }
                  hc_fail() { curl -fsS -m 10 "${HC_URL}/${HC_UUID}/fail" > /dev/null 2>&1; }

                  trap 'touch /signals/A.done' EXIT
                  trap 'hc_fail' ERR

                  log()   { echo "[INFO]  $(date -Iseconds) $*"; }
                  warn()  { echo "[WARN]  $(date -Iseconds) $*" >&2; }
                  error() { echo "[ERROR] $(date -Iseconds) $*" >&2; exit 1; }
                  check_file() { [[ -s "$1" ]] || error "File missing or empty: $1"; }

                  source /export/.env

                  curl -fsS -m 10 "${HC_URL}/${HC_UUID}/start" > /dev/null 2>&1

                  log "Applying S3 policies for Restic…"
                  aws s3api put-bucket-policy \
                    --bucket "${BUCKET}" \
                    --endpoint-url "${AWS_ENDPOINT_URL}" \
                    --policy "file:///policies/restic-policy.json"
                  aws s3api put-public-access-block \
                    --bucket "${BUCKET}" \
                    --endpoint-url "${AWS_ENDPOINT_URL}" \
                    --public-access-block-configuration "file:///policies/public-access-block-restic.json"

                  run_restic_backup() {
                    restic backup \
                      --host "${HOSTNAME}" \
                      --tag "restic_version:$(restic version | awk 'NR==1{print $2}')" \
                      --tag "bw_cli_version:${BW_CLI_VERSION}" \
                      --tag "vaultwarden_version:${VW_VERSION}" \
                      --tag "age_version:${AGE_VERSION}" \
                      --tag "environment:production" \
                      "${BACKUP_DATA_PATH}"

                    restic check --read-data
                    restic forget --keep-within "180d" --prune
                  }
                  
                  log "Starting Restic backup…"
                  run_restic_backup
                  log "Restic backup completed."

                  hc_ping
                  

            - name: final-cleanup
              image: ghcr.io/tryrocket-cloud/home-ops:toolkit-ac3e21cade59942ed7c1ef4a8dc595b3a71d815a
              volumeMounts:
                - name: signals
                  mountPath: /signals
                - name: policies
                  mountPath: /policies
              envFrom:
                - secretRef:
                    name: all-in-one
                - secretRef:
                    name: healthchecksio
              command:
                - /bin/bash
                - -eo
                - pipefail
                - -c
                - |
                  log() { echo "[INFO]  $(date -Iseconds) $*"; }

                  log "waiting for A and B to finish"
                  until [ -f /signals/A.done ]; do
                    sleep 1
                  done
                  log "all workers done; blocking s3"

                  on_exit() {
                    log "Applying final S3 block policy…"
                    aws s3api put-public-access-block \
                      --bucket "${BUCKET}" \
                      --endpoint-url "${AWS_ENDPOINT_URL}" \
                      --public-access-block-configuration "file:///policies/public-access-block-deny-all.json"
                    aws s3api put-bucket-policy \
                      --bucket "${BUCKET}" \
                      --endpoint-url "${AWS_ENDPOINT_URL}" \
                      --policy "file:///policies/deny-all-policy.json"
                  }

                  on_exit
                  log "all done! exiting…"
                  exit 0